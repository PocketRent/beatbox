#!/usr/bin/env hhvm
<?hh

require __DIR__ . '/../xhp/init.php';
require __DIR__ . '/../php/functions/collections.php';

function makeMap() : Map<string, Map<string, string>> {
	$lookIn = __DIR__ . '/../..';

	$map = Map<string, Map<string, string>> {};

	$GLOBALS['base'] = realpath(__DIR__ . '/../..');

	foreach(glob($lookIn, GLOB_ONLYDIR) as $dir) {
		$map = map_merge_recursive($map, handleDir($dir));
	}

	$export_map = var_export($map, true);

	$date = date(DATE_ISO8601);

	$php = <<<PHP
<?hh
// Generated by build/classmap at $date
\$map = $export_map;

PHP;

	$mapPath = __DIR__ . '/../conf/map.php';

	if(!file_put_contents($mapPath, $php)) {
		throw new Exception('Unable to write classmap to ' . $mapPath);
	}

	return $map;
}

function handleDir(string $dir) : Map<string, Map<string, string>> {
	$dir = realpath($dir);
	if(!$dir) return Map<string, Map<string, string>> {};

	$map = Map<string, Map<string, string>> {
		'class' => Map <string, string> {},
		'function' => Map <string, string> {},
		'constant' => Map <string, string> {},
		'type' => Map <string, string> {}
	};

	foreach(glob($dir . '/*') as $file) {
		if($file[0] == '.') continue;
		if(is_dir($file)) {
			$map = map_merge_recursive($map, handleDir($file));
		} else {
			$filename = str_replace($GLOBALS['base'], '', $file);
			$filename = ltrim($filename, '/');

			if (substr($filename, -4) != '.php') continue;

			$contents = file_get_contents($file);
			// Pull out namespace
			if(preg_match('#^namespace +(\S+);#mi', $contents, $match)) {
				$ns = $match[1] . '\\';
			} else {
				$ns = '';
			}

			if(preg_match_all('#^(?:(?:abstract|final) *)?(?:class|interface|trait) +(:?[a-z_][a-z0-9:_-]*)#mi', $contents, $matches, PREG_SET_ORDER)) {
				foreach($matches as $match) {
					if($match[1][0] == ':') {
						$match[1] = :x:base::element2class(substr($match[1], 1));
					}
					$name = strtolower($ns . $match[1]);
					$map['class'][$name] = $filename;
				}
			}

			if (preg_match_all('#^function\s+([\w_]+)#mi', $contents, $matches, PREG_SET_ORDER)) {
				foreach($matches as $match) {
					$map['function'][strtolower($match[1])] = $filename;
				}
			}

			if (preg_match_all('#^\s*define\([\'"](\S+)[\'"]#mi', $contents, $matches, PREG_SET_ORDER)) {
				foreach ($matches as $match) {
					$map['constant'][$match[1]] = $filename;
				}
			}
		}
	}

	return $map;
}

if (isset($argc)) {
	makeMap();
}
